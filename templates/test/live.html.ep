% content_for 'ready_function' => begin
    % if (my $current_user = current_user) {
        window.ownUserId = <%= $current_user->id %>;
        window.isAdmin = <%= ($current_user->is_admin) ? ('true') : ('false') %>;
    % }
    setupDeveloperPanel();
% end

<div class="card card-outline-secondary filter-panel-bottom" id="developer-panel" data-developer-url="<%= $ws_developer_url %>" data-status-only-url="<%= $ws_status_only_url %>">
    <div class="card-header">
        <strong>Developer mode</strong>
        <span>
            <span class="developer-mode-element" data-hidden-on="isConnected">
                retrieving status <i class="fas fa-spinner fa-spin fa-lg"></i>
            </span>
            <span class="developer-mode-element" id="developer-status-info" data-visible-on="isConnected">
                unknown status
            </span>
        </span>
        <div class="card-header-appendix" id="developer-session-info">
            % if (my $developer_session = $job->developer_session) {
                % my $tab_count = $developer_session->ws_connection_count;
                owned by <%= $developer_session->user->name %>
                (started
                    <abbr class="timeago" title="<%= $developer_session->t_created->datetime() %>Z">
                        %= format_time($developer_session->t_created)
                    </abbr>,
                developer has <%= $tab_count %> browser <%= $tab_count == 1 ? 'tab' : 'tabs' %> open)
            % }
            % else {
                no developer session opended
                % if (is_admin) {
                    - click to open
                % }
            % }
        </div>
    </div>
    <div class="card-body">
        <form action="#" method="get" id="developer-form" class="developer-mode-element" data-hidden-on="lockedByOtherDeveloper">
            <p class="developer-mode-element" data-hidden-on="ownSession">
                Select what you want to do and confirm using the button below. This will start a developer
                session which will lock those developer options for other users.
            </p>
            <p class="developer-mode-element" data-visible-on="ownSession">
                You started a developer session. Use the controls above to control the test behavior.
            </p>
            <h3>
                Pause test execution
                <%= help_popover('Help for <i>pause test execution</i>' => '
                        <p>Pauses the test execution. So far it is only possible to pause at a
                        specific module. The test can then be accessed via VNC for further
                        investigation.</p>
                        <p>Resuming the job after it has been paused is possible.</p>')
                %>
            </h3>
            <div class="form-group row">
                <label for="developer-pause-at-module" class="col-sm-3 col-form-label">
                    at specific module
                </label>
                <div class="col-sm-9">
                    %= include 'test/module_select'
                </div>
            </div>
            <hr>
            <div>
                <a href="#" onclick="startDeveloperSession(); return false;"
                    class="btn btn-warning developer-mode-element" data-hidden-on="ownSession">
                    <i class="fas fa-lock"></i> Confirm & start developer session
                </a>
                <a href="#" onclick="quitDeveloperSession(); return false;"
                    class="btn btn-danger developer-mode-element" data-visible-on="ownSession">
                    <i class="far fa-stop-circle"></i> Cancel job
                </a>
                <a href="#" onclick="resumeTestExecution(); return false;" class="btn btn-secondary developer-mode-element" data-visible-on="isPaused">
                    <i class="far fa-play-circle"></i> Resume test execution
                </a>
                % if (app->mode eq 'development') {
                    <a href="<%= url_for('developer_ws_console')->query({proxy => 1}) %>" target="blank"
                        class="btn btn-secondary developer-mode-element" data-visible-on="ownSession">
                        <i class="fas fa-terminal"></i> Open console
                    </a>
                % }
            </div>
        </form>
        <div class="developer-mode-element" data-visible-on="lockedByOtherDeveloper">
            The development session has already been started by <span class="developer-mode-user">another user</span>, so you can't claim it.
        </div>
        <div class="developer-mode-element" data-hidden-on="isConnected">
            <i class="fas fa-spinner fa-spin fa-lg"></i> <span id="developer-loading-info">establishing connection to backend ...</span>
        </div>
    </div>
</div>

<div id="canholder" data-url="<%= url_for('apiv1_create_command', workerid => 'WORKERID')%>">
  <canvas id="livestream" width="1024" height="768" data-url='<%= url_for("streaming", testid => $testid) %>'>
  </canvas>
</div>

<div class="card filter-panel-bottom" id="live-log-panel">
    <div class="card-header">
        <strong>Live log</strong>
        <span>click to toggle</span>
    </div>
    <div class="card-body">
        <pre id="livelog" data-url='<%= url_for("livelog", testid => $testid) %>'></pre>
        <form action="#">
            <div>
                <input type="checkbox" id="scrolldown" checked="checked" />
                <label for="scrolldown">Autoscroll log</label>
            </div>
        </form>
    </div>
</div>

<div class="card filter-panel-bottom" id="live-terminal-panel">
    <div class="card-header">
        <strong>Serial output</strong> (serial0.txt and serial_terminal.txt)
        <span>click to toggle</span>
    </div>
    <div class="card-body">
        <pre id="liveterminal" data-url='<%= url_for("liveterminal", testid => $testid) %>'></pre>
    </div>
</div>
