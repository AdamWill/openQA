#!/usr/bin/perl -w
use strict;
use CGI ":standard";
use lib "/srv/www/cgi-bin/modules";
use awstandard;
#use sort_table;
use openqa;

my $name=$ENV{PATH_INFO};

$name=~s/^\/(.*)/$1/;

my @runner = </space/geekotest/$prj/pool/[0-9]>;
my $basepath = '';
foreach my $path (@runner) {
	my $testfile = $path."/testname";
	open(my $fd, $testfile) || next ;
	my @rname = <$fd>;
	my $rnam = $rname[0];
	$rnam=~s/^(.*)\n/$1/;
	close($fd);
	if ($name eq $rnam) {
		$basepath = $path."/";
		last;
	}
}

my $img = qq(<img src="/mjpeg/$name" alt="Waiting for new Images..." />);
if($basepath eq '') {
	$img = qq(<font color="red"><b>Error:</b> Test not running!</font>);
}


my ($header,$footer)=get_header_footer(qq{Running Tests &gt; $name});
$header=~s{<!-- ADDHEADERLINES -->}{<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.1.0/prototype.js" type="text/javascript"></script>};
$header=~s{<!-- DEFSTYLE_START}{};
$header=~s{DEFSTYLE_END -->}{};
$header=~s{FLUIDSTYLE_START -->}{};
$header=~s{<!-- FLUIDSTYLE_END}{};
$header=~s{container_12}{container_16};
$header=~s{container_16}{container_16};
$header=~s{grid_9}{grid_16};
print header("text/html").
$header.
'
<div id="content" class="container_16 content-wrapper">
  <div class="grid_2 box box-shadow alpha" id="cropdetails_box">
    <div class="box-header aligncenter">Actions</div>
    <div class="aligncenter">
      <a href="/results/"><img src="/images/back.png" alt="back" title="back to result page" /></a> 
    </div>
  </div>

  <div class="grid_14 box box-shadow omega">
    <div style="margin: 0 10px;">
      <div style="width: 800px; height: 600px; background-color: #202020;">
        '.$img.'
      </div>
    </div>
  </div>


  <div class="grid_16 box box-shadow alpha" onmouseover="window.scrolldownc = 0;" onmouseout="scrolldownc = 1;">
	<script type="text/javascript">
		var scrolldownc = 1;
	</script>
  	<div class="box-header aligncenter">Live Log (Module: <span id="module-span"></span>)</div>
	<div style="margin: 0 10px;">
		<iframe id="livelog" src="/livelog/'.$name.'" style="width: 98.9%; height: 20em;"><a href="'.$basepath.'currentautoinst-log.txt">Test Log</a></iframe>
	</div>
	<script type="text/javascript">
		function scrolldown() {
			
			if(window.scrolldownc) {
				document.getElementById("livelog").contentWindow.scrollTo(0, 99999999);
			}
			window.setTimeout("scrolldown()", 50);
		}
		function updatemodule() {
			var url = "/livelog/'.$name.'?log=current";
			new Ajax.Request(url, {
				method: "get",
				onSuccess: function(response) {
					// Set Module
					document.getElementById("module-span").innerHTML = response.responseText;
					window.setTimeout("updatemodule()", 1000);
				}
			});
		}

	scrolldown();
	updatemodule();
	</script>
  </div>

</div>
'.
$footer;

